class AggregateController < ApplicationController
  def cpvVsCompany
    companies = {}
    cpvGroup = CpvGroup.find(params[:cpvGroup])
    classifiers = cpvGroup.tender_cpv_classifiers
    cpvAggregates = nil
    sqlString = ''
    #change this to look at cpv type
    puts "CPV GROUP ID" + cpvGroup.id.to_s
    if cpvGroup.id == 1
      puts "WE ARE IN HEREEEE"
      cpvAggregates = AggregateCpvRevenue.all
    else
      puts "YARRRR"
      classifiers.each do |classifier|
        puts classifier.cpv_code
        sqlString += "cpv_code = "+classifier.cpv_code.to_s+ " OR "
      end
      puts sqlString
      sqlString = sqlString[0..-4]
      puts "STRINNNG" 
      puts sqlString
      cpvAggregates = AggregateCpvRevenue.where(sqlString)
    end
   
    cpvAggregates.each do |companyAggregate|
      companyData = companies[companyAggregate.organization_id]
      company = Organization.find(companyAggregate.organization_id)
      if not companyData
        companies[companyAggregate.organization_id] = { :total => companyAggregate.total_value, :company => company }
      else
        companyData[:total] = companyData[:total] + companyAggregate.total_value  
        companies[companyAggregate.organization_id] = companyData
      end
    end


    totalContractValues = []   
    companyArray = []
    companies.each do |index,hash|
      companyArray.push(hash)
    end
    companyArray.sort! { |a,b| (a[:total] > b[:total] ? -1 : 1) }
    @TopTen = []
    count = 1
    companyArray.each do |company|
      @TopTen.push(company)
      count = count + 1
      if count > 10
        break
      end
    end

  end
end
