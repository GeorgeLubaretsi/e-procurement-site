<script type="text/javascript" charset="utf-8">

$(function () {
    var winLossGraph;
    var cpvCodeChart;
    var procurerGraph;
    var competitorGraph;
    var tendersValueGraph;
 
    $(document).ready(function() {

          winlossChart = new Highcharts.Chart({
            chart: {
                renderTo: 'winLossChart',
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
            },
            title: {
                text: 'Tenders Won Vs Tenders Lost'
            },
            tooltip: {
        	    pointFormat: '{series.name}: <b>{point.percentage}%</b>',
            	percentageDecimals: 1
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        color: '#000000',
                        connectorColor: '#000000',
                        formatter: function() {
                            return '<b>'+ this.point.name +'</b>:' +this.y;
                        }
                    }
                }
            },
            series: [{
                type: 'pie',
                name: 'Tenders Won/Lost',
                data: [ ["Tenders Won", <%= @numTendersWon %>],["Tenders Lost", <%= @numTenders-@numTendersWon %>] ]
            }]
        });

        cpvCodeChart = new Highcharts.Chart({
            chart: {
                renderTo: 'cpvDistributionChart',
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
            },
            title: {
                text: 'Tender CPV Code Distribution'
            },
            tooltip: {
        	    pointFormat: '{series.name}: <b>{point.percentage}%</b>',
            	percentageDecimals: 1
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        color: '#000000',
                        connectorColor: '#000000',
                        formatter: function() {
                            return '<b>'+ this.point.name +'</b>:' +this.y;
                        }
                    }
                }
            },
            series: [{
                type: 'pie',
                name: 'Tenders by CPV Code',
                data: [ <% @topFiveCpvs.each do |cpv| %> <%= raw cpv %>, <% end %>]
            }]
        });



          procurerGraph = new Highcharts.Chart({
            chart: {
                renderTo: 'ProcurersChart',
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
            },
            title: {
                text: 'Procurers'
            },
            tooltip: {
        	    pointFormat: '{series.name}: <b>{point.percentage}%</b>',
            	percentageDecimals: 1
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        color: '#000000',
                        connectorColor: '#000000',
                        formatter: function() {
                            return '<b>'+ this.point.name +'</b>:' +this.y;
                        }
                    }
                }
            },
            series: [{
                type: 'pie',
                name: 'Procurers that this company has won contracts with',
                data: [ <% @topTenProcuringEntities.each do |procurer| %> 
                          <% item = [ link_to(procurer[0].name,  :controller => "organizations", :action => "show_procurer", :id => procurer[0]), procurer[1] ] %>
                          <%= raw item %>, 
                        <% end %>]
            }]
        });

        competitorGraph = new Highcharts.Chart({
            chart: {
                renderTo: 'competitorChart',
                type: 'bar'
            },
            title: {
                text: 'Competitors'
            },
           xAxis: {
              categories: [
                 "Tenders bid on",
                 <% @competitors.each do |competitor| %> 
                    <% item = [link_to(competitor[0].name, organization_path(competitor[0].id))] %>
                    <%= raw item %>, 
                 <% end %>
              ]
           },
           yAxis: {
              title: {
                 text: 'Tenders'
              }
           },
            plotOptions: {
            },
            series: [{
                name: 'Tenders',
                data: [ 
                        ["Number of tenders bid on", <%= @numTenders %>],
                        <% @competitors.each do |competitor| %> 
                          <% item = [ link_to(competitor[0].name, organization_path(competitor[0].id)), competitor[1] ] %>
                          <%= raw item %>, 
                        <% end %>
                        ]
            }]
        });


      <% if  @simpleTenderStats.count > 0  %>
      	chart = new Highcharts.StockChart({
			    chart : {
				    renderTo : 'tendersValueChart',
            type: 'column'
			    },

			    rangeSelector : {
				    selected : 5
			    },

			    title : {
				    text : 'Simple Electronic Tender Activity'
			    },
          yAxis: {
              title: {
                  text: 'Lari'
              },
              min: 0
          }, 
          plotOptions: {
          series: {
              cursor: 'pointer',
              point: {
                  events: {
                      click: function() {
                          parent.location=this.myData;
                      }
                  }
              }
            }
         },

			    series : [{
				    name : 'Estimated Value',
				    data : [ <% @simpleTenderStats.each do |key,tender| %>
                    { 
                     x: <%=key*1000*86400%>, 
                     y: <%=tender[0].estimated_value.to_i%>,
                     myData: "<%= tender_path(tender[0].id) %>"
                    },
                  <%end%> 
                    ],
            dataGrouping: {
              enabled : false
			      }
			    },{		    
            name : 'Actual Value',
				    data : [ <% @simpleTenderStats.each do |key,tender| %>
                      { 
                       x: <%=key*1000*86400%>, 
                       y: <%=tender[1].to_i%>,
                       myData: "<%= tender_path(tender[0].id) %>"
                      },
                    <%end%> 
                    ],
            dataGrouping: {
              enabled : false
			      }
           }  
          ]
		    });
      <% end %>

      <% if  @TenderStats.count > 0  %>
      	altChart = new Highcharts.StockChart({
			  chart : {
				  renderTo : 'altTendersValueChart',
          type: 'column'
			  },

			  rangeSelector : {
				  selected : 5
			  },
      
        plotOptions: {
          series: {
              cursor: 'pointer',
              point: {
                  events: {
                      click: function() {
                          parent.location=this.myData;
                      }
                  }
              }
            }
         },

			  title : {
				  text : 'Electronic Tender Activity'
			  },
        yAxis: {
            title: {
                text: 'Lari'
            },
            min: 0
        }, 

		    series : [{
				    name : 'Estimated Value',
				    data : [ <% @TenderStats.each do |key,tender| %>
                      { 
                       x: <%=key*1000*86400%>, 
                       y: <%=tender[0].estimated_value.to_i%>,
                       myData: "<%= tender_path(tender[0].id) %>"
                      },
                      <%end%>
                    ],
            dataGrouping: {
               enabled : false
			      }
			    },{		    
            name : 'Actual Value',
				    data : [ <% @TenderStats.each do |key,tender| %>
                      { 
                       x: <%=key*1000*86400%>, 
                       y: <%=tender[1].to_i%>,
                       myData: "<%= tender_path(tender[0].id) %>"
                      },
                    <%end%> 
                    ],
            dataGrouping: {
               enabled : false
			      }
			    }
        ]
		  });
    <% end %>
  })
});
</script>

<%- model_class = Organization -%>
<div class="page-header">
  <h1><%=t '.title', :default => model_class.model_name.human %></h1>
</div>

<dl class="info-horizontal">
  <dt><strong><%= model_class.human_attribute_name(:name) %>:</strong></dt>
  <dd><%= @organization.name %></dd>

  <dt><strong>Identification code:</strong></dt>
  <dd><%= @organization.code %></dd>

  <dt><strong><%= model_class.human_attribute_name(:org_type) %>:</strong></dt>
  <dd><%= t(@organization.org_type) %></dd>

  <dt><strong><%= model_class.human_attribute_name(:city) %>:</strong></dt>
  <dd><%= @organization.city %></dd>

  <dt><strong><%= model_class.human_attribute_name(:address) %>:</strong></dt>
  <dd><%= @organization.address %></dd>

  <dt><strong><%= model_class.human_attribute_name(:phone_number) %>:</strong></dt>
  <dd><%= @organization.phone_number %></dd>

  <% if @organization.fax_number.length > 0 %>
    <dt><strong><%= model_class.human_attribute_name(:fax_number) %>:</strong></dt>
    <dd><%= @organization.fax_number %></dd>
  <% end %>

  <dt><strong><%= model_class.human_attribute_name(:email) %>:</strong></dt>
  <dd><%= mail_to @organization.email %></dd>

  <dt><strong><%= model_class.human_attribute_name(:webpage) %>:</strong></dt>
  <dd><a href="<%= @organization.webpage%>"> <%= @organization.webpage %></a></dd>
</dl>
<hr>


<div id="winLossChart" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
<div id="cpvDistributionChart" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
<div id="ProcurersChart" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
<div id="competitorChart" style="min-width: 400px; height: 400px; margin: 0 auto"></div>

<% if  @simpleTenderStats.count > 0  %>
<div id="tendersValueChart" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
<% end %>

<% if  @TenderStats.count > 0  %>
  <div id="altTendersValueChart" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
<% end %>
<br>


Total Estimated Value of Contracts Won = <%= @totalEstimatedValueOfContractsWon %>
<br>
Total Actual Value of Contracts Won = <%= @totalValueOfAllContracts %>
<br>
Estimated vs Actual Ratio = <%= @EstimatedVActual %>
<br>
Average Number of Bidders on Contracts Won = <%= @averageNumBiddersOnContractsWon %>
<hr>


<br></br>
<h3>Tenders Bid On</h3>
<br></br>
  <p>
    Download:
    <%= link_to "CSV", :controller => "organizations", :action => "download_org_tenders", :format => "csv", :id => @organization.id %>
  </p>
  <table class="dataTable" cellpadding="0" cellspacing="0" border="0" width="100%">
  <thead>
    <tr>
      <th>Tender</th>
      <th>Success?</th>
      <th>No. Bidders</th>
      <th>Procurer</th>
      <th>Annoucement Date</th>
      <th>Bid Duration</th>
      <th>Procurer Estimate</th>
      <th>First Bid</th>
      <th>Last Bid</th>
      <th>Number of Bids</th>
    </tr>
  </thead>
  <tbody>      
    <% @tenderInfo.each do |tender| %>
      <tr>
        <td><%= link_to tender[:tenderCode], tender_path(tender[:id]) %></td> 
        <% if tender[:won] %>
          <td><font color="green"><strong>YES</strong></font></td>
        <% else %>
          <td><font color="red">NO</font></td>
        <% end %>
        <td><%= tender[:numBidders]%></td>
        <td><%= link_to tender[:procurerName], :controller => "organizations", :action => "show_procurer", :id => tender[:procurerID] %></td>
        <td><%= tender[:tenderAnnouncementDate]%></td>
        <td><%= tender[:bidDuration]%> Days</td>
        <td><%= tender[:start_amount] %></td>
        <td><%= tender[:highest_bid] %></td>
        <td><%= tender[:lowest_bid] %></td>
        <td><%= tender[:numBids] %></td>
      </tr>
    <% end %>
  </tbody>
</table>

